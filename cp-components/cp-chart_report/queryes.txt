јктивных объектов по риэлторам группы, объектов проданных за мес€ц, объектов купленных за мес€ц, объектов на задатке:   


SELECT r.fio as rieltor,  
(SELECT COUNT(o.id) FROM objects o 
	WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 1 month) AND NOW()) as 'объектов проданных за мес€ц', 
(SELECT COUNT(o.id) FROM objects o WHERE o.buyer = r.id AND o.status = 'sold' AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 1 month) AND NOW()) as 'объектов купленных за мес€ц', 
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'deposit') as 'объектов на задатке' FROM `users` u LEFT JOIN users r ON r.manager_id = u.id  WHERE u.id = 333


SELECT r.fio as rieltor,  r.id as rieltor_id,
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 1 month) AND NOW()
) as 'объектов проданных за this',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 2 month) AND interval 1 month
) as 'объектов проданных за this-1',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 3 month) AND interval 2 month
) as 'объектов проданных за this-2',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 4 month) AND interval 3 month
) as 'объектов проданных за this-3'
FROM `users` u LEFT JOIN users r ON r.manager_id = u.id WHERE u.id = 333



SELECT r.fio as rieltor,
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND MONTH(o.sold_date)= MONTH(NOW()) and YEAR(o.sold_date) = YEAR(NOW())
) as 'объектов проданных за this',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN 
(LAST_DAY( DATE_SUB( CURDATE( ) , INTERVAL 2 MONTH ) ) + INTERVAL 1 DAY)
AND  ( DATE_ADD( LAST_DAY( CURDATE( ) - INTERVAL 1 MONTH ) , INTERVAL 1 DAY ))
) as 'объектов проданных за this-1',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN 
(LAST_DAY( DATE_SUB( CURDATE( ) , INTERVAL 3 MONTH ) ) + INTERVAL 1 DAY)
AND  ( DATE_ADD( LAST_DAY( CURDATE( ) - INTERVAL 2 MONTH ) , INTERVAL 1 DAY ))
) as 'объектов проданных за this-2',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN 
(LAST_DAY( DATE_SUB( CURDATE( ) , INTERVAL 3 MONTH ) ) + INTERVAL 1 DAY)
AND  ( DATE_ADD( LAST_DAY( CURDATE( ) - INTERVAL 2 MONTH ) , INTERVAL 1 DAY ))
) as 'объектов проданных за this-3'
FROM `users` u LEFT JOIN users r ON r.manager_id = u.id WHERE u.id = 333


PIVOT
(
r.fio
for

)



SELECT r.fio as rieltor,  r.id as rieltor_id,
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND MONTH(o.sold_date)= MONTH(NOW()) and YEAR(o.sold_date) = YEAR(NOW())
) as 'объектов проданных за this',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN 
(LAST_DAY( DATE_SUB( CURDATE( ) , INTERVAL 2 MONTH ) ) + INTERVAL 1 DAY)
AND  ( DATE_ADD( LAST_DAY( CURDATE( ) - INTERVAL 1 MONTH ) , INTERVAL 1 DAY ))
) as 'объектов проданных за this-1',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN 
(LAST_DAY( DATE_SUB( CURDATE( ) , INTERVAL 3 MONTH ) ) + INTERVAL 1 DAY)
AND  ( DATE_ADD( LAST_DAY( CURDATE( ) - INTERVAL 2 MONTH ) , INTERVAL 1 DAY ))
) as 'объектов проданных за this-2',
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN 
(LAST_DAY( DATE_SUB( CURDATE( ) , INTERVAL 3 MONTH ) ) + INTERVAL 1 DAY)
AND  ( DATE_ADD( LAST_DAY( CURDATE( ) - INTERVAL 2 MONTH ) , INTERVAL 1 DAY ))
) as 'объектов проданных за this-3'
FROM `users` u LEFT JOIN users r ON r.manager_id = u.id WHERE u.id = 333






SELECT r.fio as rieltor,  r.id as rieltor_id, month(o.sold_date) as 'мес€ц', count(o.sold_date) as 'количество'
FROM `users` u
LEFT JOIN users r ON (r.manager_id = u.id)
LEFT JOIN objects o ON ( o.user_id = r.id AND o.status = 'sold' and year(o.sold_date)=2012  )
WHERE u.id = 333
group by month(o.sold_date), r.id





объекты за мес€ц всеми риелторами по менеджерам

SELECT r.fio as rieltor,  u.id as manager_id,
(SELECT COUNT(o.id) FROM objects o WHERE o.user_id = r.id AND o.status = 'sold' 
	AND o.sold_date BETWEEN DATE_SUB(NOW(),interval 1 month) AND NOW()
) as 'объектов проданных за this'
FROM `users` u LEFT JOIN users r ON r.manager_id = u.id 
where r.fio IS NOT NULL





SELECT u.id as manager_id, r.fio as rieltor, month(o.sold_date) as 'мес€ц', count(o.sold_date) as 'количество'
FROM `users` u
left JOIN users r ON (r.manager_id = u.id)
LEFT JOIN objects o ON ( o.user_id = r.id AND o.status = 'sold' and year(o.sold_date)=2012  )
where o.sold_date is not null and r.fio is not null
group by manager_id, month(o.sold_date), r.id


интересно, сервер л€жет?)))
SELECT u.id as manager_id, r.fio as rieltor, o.id as 'мес€ц'
FROM `users` u
left JOIN users r ON (r.manager_id = u.id)
LEFT JOIN objects o ON ( o.user_id = r.id AND o.status = 'active' )
where o.id is not null and u.id is not null
group by manager_id, r.id

